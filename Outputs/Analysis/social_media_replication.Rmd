---
title: "Allcott & Gentzkow （2017）"
author: "Dan Xu"
date: "3/16/2021"
output:
  word_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Import dataset
```{r}
# library("reticulate")
# import("pandas")
# 
# # Set the path to the Python executable file
# use_python("/opt/anaconda3/bin/python", required = T)
# 
# # config <- system2(command = python, args = paste0('"', config_script, '"'), stdout = TRUE, stderr=T)
# 
# # Check the version of Python.
# py_config()
```

```{r}
# import pandas as pd
# 
# def main():
#     measures   = ['Traffic_Sources',
#                   'Monthly_Visits']
#     categories = {'News': 50,
#                   'News_Newspapers': 21,
#                   'Society_Politics': 20,
#                   'fake': 13}
# 
#     
#         for category in categories.keys():
#         for measure in measures:
#             data = pd.DataFrame()
#             for num in range(categories[category]):
#                 new = initialize_data('source/raw/Alexa/%s/%s_%s.csv' %(category, measure, num + 1), category)
#                 data = data.append(new)
#             data.to_csv('output/data/Alexa/%s_%s.txt' %(category, measure),
#               sep = '|', header = True, index = True, index_label = 'mother')
# 
# def initialize_data(infile, category):
#     data = pd.read_csv(infile, sep = ',', skiprows = range(0, 6), header = 0)
#     data.set_index('Metric', inplace = True)
#     data.drop('Date', axis = 1, inplace = True)
#     data.index.name = None
#     data = data.transpose()
#     data['category'] = category
#     return data
# 
# main()
```

Load libraries 
```{r}
library(ggplot2)
library(tidyverse)
library(forcats)  # recoding
library(psych)  # testing for internal consistency
library(ggpubr)
library(janitor)
```

Save the post_stratification survey as a .rData file
```{r}
 Survey <- read.csv("/Users/dans/Documents/Github/Social_media_fake_news/Inputs/Data/113992-V1/election-media-JEP-replication/source/raw/Inputs/Data/PostElectionSurvey/Sheet_1.csv",header = TRUE, sep = ",")
```

Clean the dataset
```{r}
Survey_clean <-
  Survey[, -c(1:9)]
```
glimpse at the data
```{r}
# glimpse(Survey_clean) #messey, needs rename and recode 
```

Rename cols/variables

rename 
```{r}
names(Survey_clean)[1] <- "consent"
names(Survey_clean)[2] <- "Honesty"
```
How often do you get news from the following channels. 
```{r}
names(Survey_clean)[3] <- "News_socialmedia"
names(Survey_clean)[4] <- "News_web.app"


ggplot(Survey_clean, aes(News_socialmedia)) +
  geom_bar(fill = "#0073C2FF") +
  theme_pubclean() 


longer_survey_socialmedia <- 
  Survey_clean %>% 
  select(News_socialmedia,`News_web.app`) %>% 
  pivot_longer(`News_socialmedia`:`News_web.app`, names_to = "question", values_to = "response")
print(longer_survey_socialmedia)

longer_survey_socialmedia %>% 
  na.omit() %>% 
ggplot(aes(x = response,fill = question)) +
  geom_bar() +
  facet_wrap(vars(question), ncol = 3) +
  labs(x = "Response (on a 1 to 4 scale)", y = "Number of respondents")


```

Clear column names_demographic questions 
```{r}
colnames(Survey_clean)[grep("What.is.your.age.", colnames(Survey_clean))] <-"age"
colnames(Survey_clean)[grep("What.is.your.gender.", colnames(Survey_clean))] <-"gender"
colnames(Survey_clean)[grep("Which.race.ethnicity.best.describes.you", colnames(Survey_clean))] <-"ethnicity"
colnames(Survey_clean)[grep("How.much.total.combined.money.did.all.members.of.your.HOUSEHOLD.earn.last.year.", colnames(Survey_clean))] <-"income"
colnames(Survey_clean)[grep("What.is.the.highest.degree.or.level.of.school.you.have.completed.", colnames(Survey_clean))] <-"education"
colnames(Survey_clean)[grep("Device.Types", colnames(Survey_clean))] <-"device_type"
colnames(Survey_clean)[grep("In.what.ZIP.code.is.your.home.located", colnames(Survey_clean))] <-"zipcode"
```


Partisanship
```{r}
colnames(Survey_clean)[grep("Before.the.2016.election..did.you.consider.yourself.a.Republican..a.Democrat..an.Independent..or.what." , colnames(Survey_clean))] <-"partyid"
```

Plots demographic information 
```{r}

longer_survey_demographic <- 
  Survey_clean %>% 
  select(partyid, education,ethnicity,age:income) %>% 
  pivot_longer(partyid:income, names_to = "question", values_to = "response")
print(longer_survey_demographic)

longer_survey_demographic %>% 
  na.omit() %>% 
ggplot(aes(x = response,fill = question)) +
  geom_bar() +
  facet_wrap(vars(question), ncol = 3) +
  labs(x = "Response", y = "Number of respondents")

# describe(longer_survey_demographic$income)

```
d
janitor () to clean the data 


Voting behavior
```{r}
colnames(Survey_clean)[grep("Who.did.you.vote.for.in.the.2016.presidential.election.", colnames(Survey_clean))] <-"vote_who"
colnames(Survey_clean)[grep("When.did.you.make.up.your.mind.about.who.to.vote.for.", colnames(Survey_clean))] <-"vote_when"
```

Social media usage
```{r}
colnames(Survey_clean)[grep("In.this.survey..we.ll.ask.you.about..social.media...by.which.we.mean.Facebook..Twitter..YouTube..Reddit..and.the.like..Do.you.ever.use.social.media."  , colnames(Survey_clean))] <-"social_media_often"

colnames(Survey_clean)[grep("Think.about.your.network.of.online..friends..and.other.people.you.follow.or.interact.with.on.social.media.", colnames(Survey_clean))] <-"social_media_preferred"

# Think about your network of online "friends" and other people you follow or
# interact with on social media.¬†What share of them do you think¬†preferred the
# same presidential candidate as you?


colnames(Survey_clean)[grep("hink.about.the.month.leading.up.to.the.2016.election..On.average..how.many.minutes.per.day.would.you.say.you.spent.reading", colnames(Survey_clean))] <-"news_mmins"

colnames(Survey_clean)[grep( "Of.those.minutes..how.many.were.spent.reading..watching..or.listening.to.election.news.on.social.media.", colnames(Survey_clean))] <-"news_mmins_social"

colnames(Survey_clean)[grep( "Which.of.those.sources.was.your..strong.most.important..strong..source.of.news.and.information.about.the.2016.election."  , colnames(Survey_clean))] <-"news_source"
```

Pope.Francis endorsement 
```{r}
names(Survey_clean)[16]  <-"Francis_question" #Question Viewed
names(Survey_clean)[17] <- "Francis1_Trump"
levels(as.factor(Survey_clean$Francis)) #Do you recall seeing this reported or discussed¬†prior to the election?


# At the time of the election, would your best guess have been that this
# statement was true?
names(Survey_clean)[18] <- "Francis_true"

```
Clinton illegal arms
```{r}
names(Survey_clean)[19] <- "Cliton_question" #Question Viewed
names(Survey_clean)[20] <- "Cliton_arms" #Do you recall seeing this reported or discussed¬†prior to the election?
levels(as.factor(Survey_clean$Cliton_question)) 
levels(as.factor(Survey_clean$Cliton_arms)) 
names(Survey_clean)[21] <- "Cliton_true" #At the time of the election, would your best guess have been that this statement was true?

```

Ireland accepts asylum under Trump presidency
```{r}
names(Survey_clean)[22] <- "Ireland_question" #Question Viewed
names(Survey_clean)[23] <- "Ireland_asylum"#Do you recall seeing this reported or discussed¬†prior to the election?
names(Survey_clean)[24] <- "Ireland_true"
```

 the FBI uncovered evidence of a pedophile sex ring
 
```{r}
names(Survey_clean)[25] <- "FBI_question" #Question Viewed
names(Survey_clean)[26] <- "FBI_Clinton"#Do you recall seeing this reported or discussed¬†prior to the election?
names(Survey_clean)[27] <- "FBI_true"
```
FBI director 
```{r}
names(Survey_clean)[28] <- "Comey_question" #Question Viewed
names(Survey_clean)[29] <- "Comey_invsetigation"#Do you recall seeing this reported or discussed¬†prior to the election?
names(Survey_clean)[30] <- "Comey_true"
```

Trump tax plan 
```{r}
names(Survey_clean)[31] <- "tax_question"
names(Survey_clean)[32] <- "tax_Trump"
names(Survey_clean)[33] <- "tax_true"
```

Clinton paied Beyonce and J.Z.
```{r}
names(Survey_clean)[34] <- "Beyonce_question"
names(Survey_clean)[35] <- "Beyonce_Clinton"
names(Survey_clean)[36] <- "Beyonce_true"
```

Trump deported Mirada
```{r}
names(Survey_clean)[37] <- "Miranda_question"
names(Survey_clean)[38] <- "Miranda_deported"
names(Survey_clean)[39] <- "Miranda_true"
```

illary.Clinton.s.first.name.was.spelled.with.an.extra..i
```{r}
names(Survey_clean)[40] <- "spelled_question"
names(Survey_clean)[41] <- "spelled_Clinton"
names(Survey_clean)[42] <- "spelled_true"
```

Clinton campaign planed a scheme by taking Republican voters to a wrong place
```{r}
names(Survey_clean)[43] <- "scheme_question"
names(Survey_clean)[44] <- "scheme_Clinton"
names(Survey_clean)[45] <- "schme_true"
```
FBI director Comey communited with Clinton about email releaase
```{r}
names(Survey_clean)[46] <- "email_question"
names(Survey_clean)[47] <- "email_Clinton"
names(Survey_clean)[48] <- "email_true"
```

Clinton deviates funds 
```{r}
names(Survey_clean)[49] <- "funds_question"
names(Survey_clean)[50] <- "funds_Clinton"
names(Survey_clean)[51] <- "funds_true"
```

Clinton said Trump supporters deplorables
```{r}
names(Survey_clean)[52] <- "deplorables_question"
names(Survey_clean)[53] <- "deplorables_Clinton"
names(Survey_clean)[54] <- "deplorables_true"
```

Donald.Trump.refused.to.say.whether.he.would.concede.the.election.if.he.lost
```{r}
names(Survey_clean)[55] <- "lost_question"
names(Survey_clean)[56] <- "lost_Trump"
names(Survey_clean)[57] <- "lost_true"
```

Beyonce.and.Jay.Z.appeared.at.a.rally.in.support.of.Hillary.Clinton
```{r}
names(Survey_clean)[58] <- "support_question"
names(Survey_clean)[59] <- "support_Clinton"
names(Survey_clean)[60] <- "support_true"
```



```{r}
# extra_colnames <- names(Survey_clean)  # save names in this vector
# 
# names(Survey_clean)[3:65] <- paste("i", formatC(1:63, width = 2, flag = "0"), sep = "") 
```



```{r}
 saveRDS(Survey, file = "/Users/dans/Documents/Github/Social_media_fake_news/Inputs/Data/113992-V1/election-media-JEP-replication/source/raw/Inputs/Data/PostElectionSurvey/survey.rData")
```

Load the survey
```{r}
# survey <- load("/Users/dans/Documents/Github/Social_media_fake_news/Inputs/Data/113992-V1/election-media-JEP-replication/source/raw/Inputs/Data/PostElectionSurvey/survey.rData")
```

## Summary of the EDA

The battery of the fake news survey questions do not seem to contraditary to each other. expand it. []
The sample is highly skewed towards female. 


# Abstract 

In the theoretical framework of the economics of fake news,Hunt Allcott and Matthew Gentzkow (2017) conducted a survey and discovered that fake news was widely shared in favor of Donald Trump.


# Analyze the survey 
how do they find people 
1200 repondents 
13
missing data systameic 



# Intro 


# Data 
Post election survey 
115 pro-Trump fake stories
41 pro-Clinton fake stories

# EDA 

EAD with smart EAD
```{r}
library(SmartEDA)
# Overview of the data - Type = 1
ExpData(data=Survey_clean,type=1)

# Structure of the data - Type = 2
ExpData(data=Survey_clean,type=2)

```


```{r}
# Summary statistics for numerical variables
ExpNumStat(Survey_clean,by="A",gp=NULL,Qnt=seq(0,1,0.1),MesofShape=2,Outlier=TRUE,round=2,Nlim=10)

# Graphical representation of all numeric features
# Density plot (Univariate)
plot1 <- ExpNumViz(Survey_clean,target=NULL,nlim=10,Page=c(2,2),sample=4)
plot1[[1]]
```

frequency for all categorical independent variables
```{r}
# frequency for all categorical independent variables
ExpCTable(Survey_clean,Target=NULL,margin=1,clim=10,nlim=3,round=2,bin=NULL,per=T)

plot2 <- ExpCatViz(Survey_clean,target=NULL,col ="slateblue4",clim=10,margin=2,Page = c(2,1),sample=40)
plot2[[1]]
```

Summary of continuous dependent variable
```{r}
# Summary of continuous dependent variable
summary(Survey_clean[,"income"])

# Summary statistics when dependent variable is continuous incomoe
# (Correlation between Target variable vs all independet variables)
ExpNumStat(Survey_clean,by="A",gp="income",Qnt=seq(0,1,0.1),MesofShape=1,Outlier=TRUE,round=2)
```

Graphical representation of all numeric variables
```{r}
#Note: sample=8 means randomly selected 8 scatter plots
#Note: nlim=4 means included numeric variable with unique value is more than 4
plot3 <- ExpNumViz(Survey_clean,target="income",nlim=4,scatter=FALSE,fname=NULL,col="green",Page=c(2,2),sample=8)
plot3[[1]]
```

The plots above do not tell us much information. 




```{r}
plot31 <- ExpNumViz(Survey_clean,target="education",nlim=4,scatter=TRUE,fname=NULL,Page=c(2,1),sample=4)
plot31[[1]]
```
Summary of categorical variables

```{r}
# frequency for all categorical independent variables by descretized partisanship
## bin=4, descretized 4 categories based on quantiles
ExpCTable(Survey_clean,Target="partyid",margin=1,clim=10,round=2,bin=4,per=F)
```

Distributions of Numerical variables_age
```{r}
# plot4 <- ExpNumViz(Survey_clean,target="age",type=1,nlim=1,fname=NULL,col=NULL,Page=c(2,2),sample=8)
# plot4[[1]]
```
Quantile-quantile plot for numeric variables
```{r}
options(width = 150)
qqp <- ExpOutQQ(Survey_clean,nlim=10,fname=NULL,Page=c(2,2),sample=4)
qqp[[1]]
```


```{r}
ExpParcoord(Survey_clean,Group=NULL,Stsize=NULL,Nvar=c("age","education","partyid"))
```
The graph above does not tell us much information. 


Survey questions combined
```{r}

colnames(Survey_clean)


```

```{r}

test <- select(Survey_clean, matches("true"))
test %>% 
    pivot_longer(Francis_true:support_true, names_to = "question", values_to = "response") %>%
  ggplot(aes(x = response)) +
  geom_bar() +
  facet_wrap(vars(question), ncol = 3) +
  labs(x = "Response (on a 1 to 3 scale)", y = "Number of respondents")


test %>% 
  pivot_longer(Francis_true:support_true, names_to = "question", values_to = "response") %>%
  ggplot(aes(x = response, fill = question)) +
  facet_wrap(vars(question), ncol = 3) +
  geom_point(stat = "count") +
  geom_line(stat = "count") +
  labs(x = "Response (on a 1 to 5 scale)", y = "Number of respondents")


# reference: https://scc.ms.unimelb.edu.au/resources-list/simple-r-scripts-for-analysis/r-scripts
```





# EDA relationships 


Compared to the national sample 
```{r}

```


```{r}
 
```

EDA guide https://www.stat.cmu.edu/~hseltman/309/Book/chapter4.pdf 

Gender and partyid (given that these are the most crucial variables in their survey)
```{r}
Survey_clean %>%
  tabyl(gender, partyid, show_na = FALSE) %>% #excludes NA values from the table
  adorn_percentages("row") %>% # takes row percentage
  adorn_pct_formatting(digits = 2) %>% # limit % to 2 digits
  adorn_ns() #add the cell count


ggplot(data = Survey_clean, mapping = aes(x = partyid, y = Francis1_Trump,group = partyid,fill = partyid)) +
  # geom_boxplot(na.rm = TRUE)
geom_violin(rna.rm=T)

colnames(Survey_clean)

```



# Data analysis Part 2

fake news shares on Facebook for both Trump and Clinton  

```{r}
fb_share <- 
  read.csv("/Users/dans/Documents/Github/Social_media_fake_news/Inputs/Data/113992-V1/election-media-JEP-replication/source/raw/FakeNews/FB-shares---combined.csv")
```

```{r}
fb_share %>% 
  select(Pro,title) %>% 
  group_by(Pro) %>% 
  summarise_each(funs(n_distinct(.)))

fb_share[fb_share==""] <- NA

# Notice that Fb_share contains some empty rows at the end of the worksheet.Fill
# them in with NAs

fb_share %>% 
  select(Pro, FB_share) %>% 
  na.omit() %>% 
  group_by(Pro) %>% 
  summarise(total = sum(FB_share)) 


# total number of fake news stories shard on FB
sum(fb_share$FB_share,na.rm=TRUE)
  
```
As the author claims, Their database "contains 115 pro-Trump fake stories that were shared on Facebook a total of 30 million times, and 41 pro-Clinton fake stories shared a total of 7.6 million times.(p. 212)" 
My replicated results confirm that there were 41 fake new stories that had been shared on Facebook regarding Clinton, and 115 regarding Trump. However, the total number of fake news stories shared on Facebook was 31674.9 combined; and it was 5518.6 and 26156.3 for Clinton and Trump respecitively. The auhtors would need to specify how they calculated fake news shares on Facebook. 


# reproducce Figure 1
Share of Americans Believing Historical Partisan Conspiracy Theories

Load in the conspiracy dataset
```{r}
conspiracy_list <- read.delim("/Users/dans/Documents/Github/Social_media_fake_news/Inputs/Data/113992-V1/election-media-JEP-replication/source/raw/conspiracy-1/list_of_theories.txt",sep ="|", header = TRUE, dec =".")

#paste two columns by year
conspiracy_list$theory_new = paste(conspiracy_list$year, conspiracy_list$theory, sep=":")
```
plot
```{r}
conspiracy_list %>% 
  ggplot(aes(factor(theory_new),believe)) +
  geom_col() +
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 60),
                   limits = rev) + # reverse order
  scale_y_continuous(expand = c(0, 0)) +
  #https://stackoverflow.com/questions/61782882/how-to-wrap-an-x-axis-label-when-using-aes-string 
  coord_flip() + 
  ylab("Share of people who believe it is true (%)") +
  #ylim(0, 60) +
  theme_bw() +
  theme(axis.title.y  = element_blank(),
        panel.grid.major = element_blank(),
        #panel.border = element_rect(colour = "black", size=1),
        axis.line = element_line(colour = "black",size = .5)) 
#https://stackoverflow.com/questions/10861773/remove-grid-background-color-and-top-and-right-borders-from-ggplot2 

# To save the ggplot as png
ggsave(path = "/Users/dans/Documents/Github/Social_media_fake_news/Outputs/Plots", filename = "fig1.png")

``` 

Figure 2
Trends Related to Fake News





# Weighted survey 
How do they weight the survey?




# Wighted sites
by monthly visits



# references 




